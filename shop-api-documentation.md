# Overview

This shop API allows the frontend app to make various database queries, including CRUD operations for the users and items collections and other unique operations. This API utilizes jwt token user authentication wherein a user's password is encrypted before it is stored in the database and the user's password is not returned to the frontend after login/signup.

<p>&nbsp;</p>

## Database Collections

There are two collections this API deals with: a food items collection (a collection of all of the food items the shop sells) and a users collection (a collection of users of the app).

<p>&nbsp;</p>

## Items

An `item` document contains a `title`, `price`, `imgUrl`, `category`, `globalRating`, and a `users` property, in addition to an `_id` and `__v` property generated by MongoDB. The `users` property is an array containing sub-documents which are `lightweightUser` objects. The purpose of the `users` property in each `item` document is explained in the Cart section of this markdown. The schemas of the `item` document as well as the `lightweightUser` document are below:

```js
    const lightweightUserSchema = new Schema({
        userID: {
            type: Schema.Types.ObjectId,
            ref: "User",
            required: true
        },
        quantity: {
            type: Number,
            required: true
        }
    }, { _id: false })

    const itemSchema = new Schema({
        title: {
            type: String,
            required: true
        },
        price: {
            type: Number,
            required: true
        },
        imgUrl: {
            type: String,
            required: true
        },
        category: {
            type: String,
            enum: ['icecream', 'shakes', 'sandwiches'],
            required: true
        },
        globalRating: {
            type: Number,
            enum: [null, 1, 2, 3, 4, 5],
            required: true
        },
        users: {
            type: [lightweightUserSchema],
            required: true
        }
    })
```

An example item document is below:

```json
    {
        "_id": "64b3393f00c2a5e8938e9c45",
        "title": "Spicy Italian Sausage Sub",
        "price": 16.99,
        "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg/640px-Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg",
        "category": "sandwiches",
        "globalRating": 4,
        "users": [
            {
                "userID": "64b345092f4f5a5d7097fb93",
                "quantity": 2
            },
            {
                "userID": "64b3455f2f4f5a5d7097fb95",
                "quantity": 1
            }
        ],
        "__v": 0
    }
```
<p>&nbsp;</p>

## Users

A `user` document contains a `username`, `password`, and an `orders` property. The `password` property is an encrypted version of the user's actual password. The `orders` property is an array containing sub-documents which are `order` objects. Each `order` sub-document has an `items` property which is essentially an array of `item` documents (though in the Schema it is notated as an `orderedItem`). Note that the `item` documents do not have an `_id` and `__v` property generated by MongoDB as part of their schema, but the `order` sub-document does. This is because an `item` already contains those properties, whereas each new `order` requires a new ID to be generated. Note also that the `users` property of each `orderedItem` is not necessarily up to date with the current state of user carts; the singular reason the `users` property is kept is to record the quantity of the `orderedItem` that was purchased in that instance for one of the users. The schemas of the `user` document, the `order` sub-document, and the `orderedItem` sub-sub-document are below.

```js
const lightweightUserSchema = new Schema({
    userID: {
        type: Schema.Types.ObjectId,
        ref: "User",
        required: true
    },
    quantity: {
        type: Number,
        required: true
    }
}, { _id: false })

const orderedItemSchema = new Schema({
    _id: {
        type: Schema.Types.ObjectId,
        required: true
    },
    __v: {
        type: Number
    },
    title: {
        type: String,
        required: true
    },
    price: {
        type: Number,
        required: true
    },
    imgUrl: {
        type: String,
        required: true
    },
    category: {
        type: String,
        enum: ['icecream', 'shakes', 'sandwiches'],
        required: true
    },
    globalRating: {
        type: Schema.Types.Mixed,
        enum: [null, 1, 2, 3, 4, 5],
        required: true
    },
    users: {
        type: [lightweightUserSchema],
        required: true
    }
}, { _id: false, })

const orderSchema = new Schema({
    items: {
       type: [orderedItemSchema],
       required: true
    }
}, { timestamps: true })

const userSchema = new Schema({
    username: {
        type: String,
        required: true
    },
    password: {
        type: String,
        required: true
    },
    orders: {
        type: [orderSchema],
        required: true
    }
}, { timestamps: true })

```


An example user document is also below:


```json
        {
        "_id": "64b3455f2f4f5a5d7097fb95",
        "username": "nancy_pie",
        "password": "$2b$10$uCP8HmXEmRimexsn8dL1KeDXK0TaaYWLSG0mFJRCLI1wvhkRlL2za",
        "orders": [
            {
                "items": [
                    {
                        "_id": "64b4d01c31e24c299bf32241",
                        "__v": 0,
                        "title": "Large Strawberry Milkshake",
                        "price": 9.99,
                        "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Strawberry_milkshake_in_black_background.png/640px-Strawberry_milkshake_in_black_background.png",
                        "category": "shakes",
                        "globalRating": null,
                        "users": [
                            {
                                "userID": "64b3455f2f4f5a5d7097fb95",
                                "quantity": 1
                            },
                            {
                                "userID": "64b818d4e823be488ea3fbe0",
                                "quantity": 2
                            },
                            {
                                "userID": "64b3455f2f4f5a5d7097fb95",
                                "quantity": 1
                            }
                        ]
                    },
                    {
                        "_id": "64b4d11d31e24c299bf32255",
                        "__v": 0,
                        "title": "Spicy Italian Sausage Sub",
                        "price": 16.99,
                        "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg/640px-Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg",
                        "category": "sandwiches",
                        "globalRating": null,
                        "users": [
                            {
                                "userID": "64b3455f2f4f5a5d7097fb95",
                                "quantity": 11
                            },
                            {
                                "userID": "64b818d4e823be488ea3fbe0",
                                "quantity": 4
                            }
                        ]
                    },
                    {
                        "_id": "64b7f66be823be488ea3f8b0",
                        "__v": 0,
                        "title": "Cookie Icecream Sandwich",
                        "price": 14.56,
                        "imgUrl": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTsypdz2UKQJD97t00wfNeRSNsKAi8HSCCV4w&usqp=CAU",
                        "category": "sandwiches",
                        "globalRating": 3,
                        "users": [
                            {
                                "quantity": 1
                            },
                            {
                                "userID": "64b3455f2f4f5a5d7097fb95",
                                "quantity": 1
                            }
                        ]
                    }
                ],
                "_id": "64bb802902cddd7bed92a0ba",
                "createdAt": "2023-07-22T07:07:21.955Z",
                "updatedAt": "2023-07-22T07:07:21.955Z"
            },
            {
                "items": [
                    {
                        "_id": "64b4d11d31e24c299bf32255",
                        "__v": 0,
                        "title": "Spicy Italian Sausage Sub",
                        "price": 16.99,
                        "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg/640px-Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg",
                        "category": "sandwiches",
                        "globalRating": null,
                        "users": [
                            {
                                "userID": "64b3455f2f4f5a5d7097fb95",
                                "quantity": 11
                            }
                        ]
                    },
                    {
                        "_id": "64b7f66be823be488ea3f8b0",
                        "__v": 0,
                        "title": "Cookie Icecream Sandwich",
                        "price": 14.56,
                        "imgUrl": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTsypdz2UKQJD97t00wfNeRSNsKAi8HSCCV4w&usqp=CAU",
                        "category": "sandwiches",
                        "globalRating": 3,
                        "users": [
                            {
                                "quantity": 1
                            },
                            {
                                "userID": "64b3455f2f4f5a5d7097fb95",
                                "quantity": 1
                            }
                        ]
                    }
                ],
                "_id": "64bb8080ca3406dc914481f9",
                "createdAt": "2023-07-22T07:08:48.254Z",
                "updatedAt": "2023-07-22T07:08:48.254Z"
            }
        ],
        "__v": 0,
        "updatedAt": "2023-07-22T07:08:48.254Z"
    }
```
<p>&nbsp;</p>

## Carts

In this database system, the cart of a specific user is the collection of item documents that contain (within their `users` property) a `lightweightUser` sub-document such that said `lightweightUser` sub-document's `userID` property matches the `_id` of the user. That said, carts are thus created and maintained by manipulating the `users` property of all of the items.

An example of a cart of a user with ID `64b3455f2f4f5a5d7097fb95` is below:

```js
    [
        {
            "_id": "64b3393f00c2a5e8938e9c45",
            "title": "Spicy Italian Sausage Sub",
            "price": 16.99,
            "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg/640px-Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg",
            "category": "sandwiches",
            "users": [
                {
                    "userID": "64b345092f4f5a5d7097fb93",
                    "quantity": 2
                },
                {
                    "userID": "64b3455f2f4f5a5d7097fb95",
                    "quantity": 1
                }
            ],
            "__v": 0
        },
        {
            "_id": "64b33e0f75c5528c7e084c7b",
            "title": "Neapolitan Icecream",
            "price": 6.99,
            "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/b/bb/So_Delicious_Dairy_Free_Neapolitan_ice_cream.jpg/640px-So_Delicious_Dairy_Free_Neapolitan_ice_cream.jpg",
            "category": "icecream",
            "users": [
                {
                    "userID": "64b3455f2f4f5a5d7097fb95",
                    "quantity": 1
                }
            ],
            "__v": 0
        }
    ]
```
<p>&nbsp;</p>

## Orders

Orders are carts (collections of `item` documents) that have been through the checkout process and are stored as sub-documents inside user documents. Each order belongs to exactly one user and has its own `_id` property.

An example order is below:

```json
    {
    "items": [
        {
            "_id": "64b4d01c31e24c299bf32241",
            "__v": 0,
            "title": "Large Strawberry Milkshake",
            "price": 9.99,
            "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/0/07/Strawberry_milkshake_in_black_background.png/640px-Strawberry_milkshake_in_black_background.png",
            "category": "shakes",
            "globalRating": null,
            "users": [
                {
                    "userID": "64b3455f2f4f5a5d7097fb95",
                    "quantity": 1
                },
                {
                    "userID": "64b818d4e823be488ea3fbe0",
                    "quantity": 2
                },
                {
                    "userID": "64b3455f2f4f5a5d7097fb95",
                    "quantity": 1
                }
            ]
        },
        {
            "_id": "64b4d11d31e24c299bf32255",
            "__v": 0,
            "title": "Spicy Italian Sausage Sub",
            "price": 16.99,
            "imgUrl": "https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg/640px-Spicy_italian_sausage_sub_%28Disney%27s_Hollywood_Studios%29_May_2023.jpg",
            "category": "sandwiches",
            "globalRating": null,
            "users": [
                {
                    "userID": "64b3455f2f4f5a5d7097fb95",
                    "quantity": 11
                },
                {
                    "userID": "64b818d4e823be488ea3fbe0",
                    "quantity": 4
                }
            ]
        },
        {
            "_id": "64b7f66be823be488ea3f8b0",
            "__v": 0,
            "title": "Cookie Icecream Sandwich",
            "price": 14.56,
            "imgUrl": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTsypdz2UKQJD97t00wfNeRSNsKAi8HSCCV4w&usqp=CAU",
            "category": "sandwiches",
            "globalRating": 3,
            "users": [
                {
                    "quantity": 1
                },
                {
                    "userID": "64b3455f2f4f5a5d7097fb95",
                    "quantity": 1
                }
            ]
        }
    ],
    "_id": "64bb802902cddd7bed92a0ba",
    "createdAt": "2023-07-22T07:07:21.955Z",
    "updatedAt": "2023-07-22T07:07:21.955Z"
}
```
<p>&nbsp;</p>

## Routes

There are six main base URLs that this API routes, namely `/api/auth`, `/api/items`, `/api/protected/cart`, `/api/protected/orders`, `/api/protected/users`, and `/api/protected/ratings`. We will peruse through each and describe the various endpoints that may be used. Note that the `_id` and `__v` properties that exist for some documents or sub-documents are not explicitly mentioned in their schemas. These properties are automatically generated by MongoDB, so any POST request to create said documents should not include them.

<p>&nbsp;</p>

#### `/api/auth`

- Endpoint: `/api/auth/signup/`
    - Method: POST
    - Description: Creates a user document for a new user and returns a jwt token and a censored user document (one without a password). The password itself is encrypted in the database.


- Endpoint: `/api/auth/login/`
    - Method: POST
    - Description: Logs a user in, assuming their username and password is correct. Returns the same as `/api/auth/signup/`.

<p>&nbsp;</p>

#### `/api/items`

- Endpoint: `/api/items/`
    - Method: GET
    - Description: Retrieves an array consisting of every item in the items collection.


- Endpoint: `/api/items/`
    - Method: POST
    - Description: Posts a new food item. Must send a JSON body that satisfies the item schema.


- Endpoint: `/api/items/category/<someCategory>/`
    - Method: GET
    - Description: Retrieves an array of all items from category `<someCategory>`. `<someCategory>` must be one of the following three strings: 'icecream', 'shakes', or 'sandwiches'.


- Endpoint: `/api/items/category/<someCategory>/search?title=<someLetters>/`
    - Method: GET
    - Description: Retrieves an array of all items from category `<someCategory>` that have `title` properties which contain each letter within `<someLetters>`. This is a basic regex search.


- Endpoint: `/api/items/<itemID>/`
    - Method: GET
    - Description: Retrieves a specific item document by its `_id` property.


- Endpoint: `/api/items/<itemID>/`
    - Method: PUT
    - Description: Updates a specific item document by its `_id` property. Must send an update object in JSON. Properties in the update object that are not in the item schema will be ignored.


- Endpoint: `/api/items/<itemID>/`
    - Method: DELETE
    - Description: Deletes a specific item document by its `_id` property.  



<p>&nbsp;</p>

#### `/api/protected/cart`


- Endpoint: `/api/protected/cart/`
    - Method: GET
    - Description: Retrieves an array of unique items in the cart of a user with the user's token in the request header.  

<p>&nbsp;</p>

#### `/api/protected/orders`  


- Endpoint: `/api/protected/orders/user/`
    - Method: GET
    - Description: Retrieves an array of all orders of a specific user via a token.


- Endpoint `/api/protected/orders/user/`
    - Method: POST
    - Description: Posts a new order consisting of the user's current cart into their user document and clears the user's cart of items, via their token. Returns the freshly posted order. This is the most complex route of the API.


- Endpoint: `/api/protected/orders/<orderID>/`
    - Method: GET
    - Description: Retrieves an order by its ID.

<p>&nbsp;</p>

#### `/api/protected/users`

The routes in this section are mostly for database management purposes, and are protected to make it harder for an outside entity to manipulate.

- Endpoint: `/api/protected/users/`
    - Method: GET
    - Description: Retrieves an array of every user in the users collection.


- Endpoint: `/api/protected/users/`
    - Method: POST
    - Description: Posts a new user into the users collection. Must send a JSON body in the request of an object that satisfies the user schema. Since this route requires a user token, it is deprecated and replaced by `/api/auth/signup`.


- Endpoint: `/api/protected/users/<userID>/`
    - Method: GET
    - Description: Retrieves a specific user by ID -- while this route is protected with a user token, the `userID` may be any user's ID. This route is mostly used for database management purposes.


- Endpoint: `/api/protected/users/<userID>/`
    - Method: PUT
    - Description: Updates a user by their ID. Must send a JSON body in the request of an update object along with a valid user token.


- Endpoint: `/api/protected/users/<userID>/`
    - Method: DELETE
    - Description: Deletes a user by their ID.

<p>&nbsp;</p>

#### `/api/protected/ratings`

- Endpoint: `/api/protected/ratings/rate/<itemID>/<userID>?index=<someOrderIndex>&rating=<someRating>/`

    - Method: PUT
    - Description: Updates a user's rating of a particular item in one of their orders. The `index` query `<someOrderIndex>` refers to the index of the relevant order in the user's `orders` array, and the `rating` query `<someRating>` is the desired rating the item is to be updated with. `<someRating>` should be one of the integers `1` through `5` or the integer `0`. The integer `0` corresponds to the item being unrated, and will update the item with a rating of `null`.

- Endpoint: `/api/protected/ratings/recalculate/<itemID>/`

    - Method: GET
    - Description: Recalculates the `globalRating` property of an item by its ID and returns the result as a JSON object with a `globalRating` property of type `Number`.

- Endpoint: `/api/protected/ratings/update/<itemID>?global=<someRating>/`

    - Method: PUT
    - Description: Updates `globalRating` property of an item by its ID via the `global` query. `<someRating>` should be one of the integers `1` through `5` or the integer `0`. The integer `0` corresponds to the item being globally unrated, and will update the item with a global rating of `null`.